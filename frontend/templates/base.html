<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PulsePoint - Your Streamlined News Pulse">
    <title>{% block title %}PulsePoint{% endblock %}</title>

    <!-- Performance: Resource Hints -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://feeds.bbci.co.uk" crossorigin>
    <link rel="preconnect" href="https://www.theguardian.com" crossorigin>
    <link rel="preconnect" href="https://feeds.skynews.com" crossorigin>
    <link rel="preconnect" href="https://www.aljazeera.com" crossorigin>
    <link rel="preconnect" href="https://techcrunch.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.wired.com">
    <link rel="dns-prefetch" href="https://www.theverge.com">
    <link rel="dns-prefetch" href="https://www.nasa.gov">
    <link rel="dns-prefetch" href="https://rss.cnn.com">
    <link rel="dns-prefetch" href="https://www.npr.org">

    <!-- Critical CSS (inlined for performance) -->
    <style>
        /* Critical CSS for above-the-fold content - inlined for performance */
        :root{--color-bg:#fafbfc;--color-bg-gradient:linear-gradient(135deg,#fafbfc 0%,#f5f7fa 100%);--color-text:#1a202c;--color-text-muted:#718096;--color-card-bg:#ffffff;--color-border:#e2e8f0;--color-accent:#3b82f6;--color-accent-hover:#2563eb;--color-accent-soft:#dbeafe;--color-source-bg:#fef3c7;--color-source-text:#92400e;--font-primary:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;--shadow-sm:0 1px 3px rgba(0,0,0,.04);--transition:all .3s cubic-bezier(.4,0,.2,1)}*{margin:0;padding:0;box-sizing:border-box}body{font-family:var(--font-primary);background:var(--color-bg-gradient);color:var(--color-text);line-height:1.6;min-height:100vh;display:flex;flex-direction:column}.header{background-color:var(--color-card-bg);border-bottom:1px solid var(--color-border);padding:3rem 0 2.5rem;margin-bottom:3rem;box-shadow:var(--shadow-sm)}.header-title{font-size:2.5rem;font-weight:700;color:var(--color-text);margin-bottom:.5rem;letter-spacing:-1px}.header-subtitle{font-size:1rem;color:var(--color-text-muted);margin:0;font-weight:400}.main-content{flex:1;padding:1rem 0 3rem}.container{max-width:1200px;margin:0 auto}@media (max-width:768px){.header{padding:2rem 0 1.5rem;margin-bottom:2rem}.header-title{font-size:1.75rem}.header-subtitle{font-size:.9rem}}
    </style>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" media="print" onload="this.media='all'">

    <!-- Non-critical CSS (loaded asynchronously) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"></noscript>

    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1 class="header-title">PulsePoint</h1>
            <p class="header-subtitle">Your Streamlined News Pulse</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container text-center">
            <p>&copy; 2025 PulsePoint. Stay informed, without the noise.</p>
        </div>
    </footer>

    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode" title="Toggle theme">
        <!-- Sun icon for light mode -->
        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
        <!-- Moon icon for dark mode -->
        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
        </svg>
    </button>

    <!-- Theme Toggle JavaScript -->
    <script>
        /**
         * Theme management system
         * - Respects user's system preference (prefers-color-scheme)
         * - Allows manual override via toggle button
         * - Persists preference to localStorage
         */
        (function() {
            const htmlElement = document.documentElement;

            // Get stored theme preference or detect system preference
            function getPreferredTheme() {
                const storedTheme = localStorage.getItem('theme');
                if (storedTheme) {
                    return storedTheme;
                }
                // Check system preference
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }

            // Apply theme to document
            function setTheme(theme) {
                htmlElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            }

            // Toggle between light and dark themes
            function toggleTheme() {
                const currentTheme = htmlElement.getAttribute('data-theme') || 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
            }

            // Initialize theme immediately (before DOM loads) to prevent flash
            setTheme(getPreferredTheme());

            // Wait for DOM to be ready before attaching event listeners
            document.addEventListener('DOMContentLoaded', function() {
                const themeToggle = document.getElementById('themeToggle');

                if (themeToggle) {
                    // Add click event listener to toggle button
                    themeToggle.addEventListener('click', toggleTheme);
                }

                // Listen for system theme changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                    // Only auto-switch if user hasn't manually set a preference
                    if (!localStorage.getItem('theme')) {
                        setTheme(e.matches ? 'dark' : 'light');
                    }
                });
            });
        })();
    </script>

    <!-- Bootstrap 5 JS Bundle (deferred for performance) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>

    <!-- Performance Monitoring (non-critical, loads last) -->
    <script>
        // Performance monitoring script - loads after page content
        window.addEventListener('load', function() {
            setTimeout(function() {
                try {
                    // Track basic performance metrics
                    const navigation = performance.getEntriesByType('navigation')[0];
                    const paintEntries = performance.getEntriesByType('paint');

                    const metrics = {
                        // Basic timing metrics
                        domContentLoaded: Math.round(navigation.domContentLoadedEventEnd - navigation.domContentLoadedEventStart),
                        loadComplete: Math.round(navigation.loadEventEnd - navigation.loadEventStart),
                        firstPaint: Math.round(paintEntries[0]?.startTime || 0),
                        firstContentfulPaint: Math.round(paintEntries[1]?.startTime || 0),

                        // Resource timing
                        totalResources: performance.getEntriesByType('resource').length,
                        slowResources: performance.getEntriesByType('resource').filter(r => r.duration > 1000).length,

                        // Navigation timing
                        dnsLookup: Math.round(navigation.domainLookupEnd - navigation.domainLookupStart),
                        tcpConnect: Math.round(navigation.connectEnd - navigation.connectStart),
                        serverResponse: Math.round(navigation.responseEnd - navigation.requestStart),

                        // Page info
                        userAgent: navigator.userAgent.substring(0, 100),
                        viewport: {
                            width: window.innerWidth,
                            height: window.innerHeight
                        }
                    };

                    // Simple Core Web Vitals tracking (basic implementation)
                    let lcpValue = 0;
                    let clsValue = 0;

                    // Largest Contentful Paint (simplified)
                    if ('PerformanceObserver' in window) {
                        try {
                            const observer = new PerformanceObserver(list => {
                                const entries = list.getEntries();
                                lcpValue = Math.round(entries[entries.length - 1]?.startTime || 0);
                            });
                            observer.observe({ entryTypes: ['largest-contentful-paint'] });

                            setTimeout(() => {
                                metrics.lcp = lcpValue;
                                sendMetrics(metrics);
                            }, 2000);
                        } catch(e) {
                            sendMetrics(metrics);
                        }
                    } else {
                        sendMetrics(metrics);
                    }
                } catch(e) {
                    console.log('Performance monitoring error:', e);
                }
            }, 1000);
        });

        function sendMetrics(metrics) {
            // Send metrics to server (non-blocking)
            if (navigator.sendBeacon) {
                const data = JSON.stringify(metrics);
                navigator.sendBeacon('/api/performance/vitals', data);
            } else {
                fetch('/api/performance/vitals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(metrics)
                }).catch(() => {}); // Silently fail
            }

            // Log to console for debugging
            console.log('PulsePoint Performance Metrics:', metrics);
        }
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
