{% extends "base.html" %}

{% block title %}PulsePoint - News Feed{% endblock %}

{% block content %}
<div class="news-container">
    {% if error %}
    <div class="alert alert-danger" role="alert">
        <strong>Error:</strong> Unable to load news feeds. {{ error }}
    </div>
    {% endif %}

    {% if articles %}
    <!-- Search/Filter Section -->
    <div class="search-container mb-4">
        <div class="search-wrapper">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input
                type="text"
                id="searchInput"
                class="search-input"
                placeholder="Search articles by title or summary..."
                aria-label="Search articles"
            />
            <button id="clearSearch" class="clear-search" aria-label="Clear search" title="Clear search" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="search-meta">
            <span id="articleCount">Showing {{ articles|length }} articles</span>
        </div>
    </div>

    <!-- No Results Message (hidden by default) -->
    <div id="noResults" class="no-results" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h3>No articles found</h3>
        <p>Try a different search term or <button id="clearSearchBtn" class="clear-link">clear your search</button></p>
    </div>

    <div class="row g-4" id="articlesGrid">
        {% for article in articles %}
        <div class="col-12 col-md-6 col-lg-4 article-item" data-title="{{ article.title|lower }}" data-summary="{{ article.summary|striptags|lower }}">
            <article class="news-card fade-in" style="animation-delay: {{ loop.index0 * 0.05 }}s;">
                <div class="news-card-header">
                    <span class="news-source">{{ article.source }}</span>
                    {% if article.published %}
                    <time class="news-date" data-timestamp="{{ article.published }}">{{ article.published }}</time>
                    {% endif %}
                </div>
                <div class="news-card-body">
                    <h2 class="news-title">
                        <a href="{{ article.link }}" target="_blank" rel="noopener noreferrer">
                            {{ article.title }}
                        </a>
                    </h2>
                    {% if article.summary %}
                    <p class="news-summary">{{ article.summary | safe }}</p>
                    {% endif %}
                </div>
            </article>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading news feeds...</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Format relative time for dates
    function formatRelativeTime(dateString) {
        try {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;

            // For older dates, show formatted date
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        } catch (e) {
            return dateString;
        }
    }

    // Search/Filter functionality
    function initializeSearch() {
        const searchInput = document.getElementById('searchInput');
        const clearButton = document.getElementById('clearSearch');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const articleCount = document.getElementById('articleCount');
        const noResults = document.getElementById('noResults');
        const articlesGrid = document.getElementById('articlesGrid');
        const articleItems = document.querySelectorAll('.article-item');
        const totalArticles = articleItems.length;

        // Debounce function to limit search execution frequency
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Filter articles based on search query
        function filterArticles(query) {
            const searchTerm = query.toLowerCase().trim();
            let visibleCount = 0;

            articleItems.forEach(function(item) {
                const title = item.getAttribute('data-title') || '';
                const summary = item.getAttribute('data-summary') || '';

                // Check if search term is in title or summary
                const matches = title.includes(searchTerm) || summary.includes(searchTerm);

                if (matches) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            // Update article count
            if (searchTerm) {
                articleCount.textContent = `Showing ${visibleCount} of ${totalArticles} articles`;
            } else {
                articleCount.textContent = `Showing ${totalArticles} articles`;
            }

            // Show/hide "no results" message
            if (visibleCount === 0 && searchTerm) {
                noResults.style.display = 'flex';
                articlesGrid.style.display = 'none';
            } else {
                noResults.style.display = 'none';
                articlesGrid.style.display = '';
            }

            // Show/hide clear button
            if (searchTerm) {
                clearButton.style.display = 'flex';
            } else {
                clearButton.style.display = 'none';
            }
        }

        // Clear search
        function clearSearch() {
            searchInput.value = '';
            filterArticles('');
            searchInput.focus();
        }

        // Event listeners
        searchInput.addEventListener('input', debounce(function(e) {
            filterArticles(e.target.value);
        }, 300));

        clearButton.addEventListener('click', clearSearch);
        clearSearchBtn.addEventListener('click', clearSearch);

        // Allow Enter key to trigger search immediately (bypass debounce)
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                filterArticles(e.target.value);
            }
        });
    }

    // Update all timestamps on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Format timestamps
        const timeElements = document.querySelectorAll('.news-date[data-timestamp]');
        timeElements.forEach(function(elem) {
            const timestamp = elem.getAttribute('data-timestamp');
            elem.textContent = formatRelativeTime(timestamp);
        });

        // Initialize search functionality
        initializeSearch();
    });

    // Auto-refresh every 5 minutes
    setTimeout(function() {
        location.reload();
    }, 300000);
</script>
{% endblock %}
